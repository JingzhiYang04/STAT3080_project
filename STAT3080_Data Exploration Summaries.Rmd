---
title: "Project1_Graphs"
output: pdf_document
date: "2025-11-05"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width = 6.5, fig.height = 4.2)
library(ggplot2)
library(dplyr)
library(readr)
library(tidyr)
library(scales)
```

```{r}
blob_url <- "https://github.com/JingzhiYang04/STAT3080_project/blob/main/project_dataset_cleaned.csv"
raw_url  <- sub("github.com", "raw.githubusercontent.com", sub("/blob/", "/", blob_url))
dat <- read_csv(raw_url, show_col_types = FALSE)

num_cols <- intersect(
  c("life_expectancy", "per_capita_pce", "median_household_income",
    "medical_enrollment", "income_rank", "pce_rank"),
  names(dat)
)

dat <- dat |>
  mutate(across(all_of(num_cols),
                ~ if (is.numeric(.x)) .x else readr::parse_number(as.character(.x))))

num_cols <- intersect(
  c("le", "pce", "median_household_income", "medical_enrollment", "income_rank", "pce_rank"),
  names(dat)
)

dat <- dat |>
  mutate(across(all_of(num_cols),
                ~ if (is.character(.x)) readr::parse_number(.x) else as.numeric(.x)))

if ("pce_quintile" %in% names(dat)) {
  dat <- dat |>
    mutate(pce_quintile = factor(pce_quintile, levels = paste0("Q", 1:5), ordered = TRUE))
}

dollar_compact <- label_number(prefix = "$", accuracy = 0.1, scale_cut = cut_si("k"))

theme_min <- theme_minimal(base_size = 10) +
  theme(
    plot.title.position = "plot",
    plot.caption = element_text(color = "grey40"),
    panel.grid.minor = element_blank()
  )
```

## Summary 1: LE vs Median Income

```{r plot_le_vs_income, echo=FALSE}
m1 <- lm(le ~ median_household_income, data = dat)
r2_1 <- summary(m1)$r.squared
slope_1 <- coef(m1)[2]

p1 <- dat |>
ggplot(aes(x = median_household_income, y = le)) +
geom_point(alpha = 0.85) +
geom_smooth(method = "lm", se = TRUE) +
scale_x_continuous(labels = dollar_compact) +
labs(
title = "Life expectancy at birth vs. median household income (2021)",
x = "Median household income (USD)", y = "Life expectancy (years)",
) +
annotate("text", x = Inf, y = -Inf,
label = sprintf("Slope = %.6f\nR² = %.3f", slope_1, r2_1),
hjust = 1.05, vjust = -0.5, size = 3) +
theme_min
p1
```

## Summary 2: LE vs PCE

```{r plot_le_vs_pce, echo=FALSE}
m2 <- lm(le ~ pce, data = dat)
r2_2 <- summary(m2)$r.squared
slope_2 <- coef(m2)[2]

p2 <- dat |>
ggplot(aes(x = pce, y = le)) +
geom_point(alpha = 0.85) +
geom_smooth(method = "lm", se = TRUE) +
scale_x_continuous(labels = dollar_compact) +
labs(
title = "LE vs. Per-capita PCE (2021)",
x = "Per-capita PCE (USD)", y = "Life expectancy (years)"
) +
annotate("text", x = Inf, y = -Inf,
label = sprintf("Slope = %.6f\nR² = %.3f", slope_2, r2_2),
hjust = 1.05, vjust = -0.5, size = 3) +
theme_min
p2
```

## Summary 3: LE vs Median Income

```{r plot_le_vs_medicare, echo=FALSE}
p3 <- dat |>
ggplot(aes(x = medical_enrollment, y = le)) +
geom_point(alpha = 0.85) +
geom_smooth(method = "lm", se = TRUE) +
scale_x_log10(labels = comma) +
labs(
title = "Life xpectancy vs. Medicare Enrollment (log scale)",
x = "Total Medicare beneficiaries (log10)", y = "Life expectancy (years)"
) + theme_min
p3
```

## Summary 4: Distributions

```{r plot_distributions, echo=FALSE}
dist_long <- dat |>
select(
`Life Expectancy (years)` = le,
`Median Household Income (USD)` = median_household_income,
`Per-capita PCE (USD)` = pce
) |>
pivot_longer(everything(), names_to = "metric", values_to = "value")

stats_df <- dist_long |>
group_by(metric) |>
summarize(mu = mean(value, na.rm = TRUE), sd = sd(value, na.rm = TRUE), .groups = "drop")

p4 <- ggplot(dist_long, aes(value)) +
geom_histogram(bins = 20, alpha = 0.85) +
geom_density(adjust = 1.0) +
facet_wrap(~ metric, scales = "free") +
geom_vline(data = stats_df, aes(xintercept = mu), linetype = 2) +
geom_text(data = stats_df,
aes(x = mu, y = Inf, label = sprintf("Mean = %.2f\nSD = %.2f", mu, sd)),
vjust = 1.1, size = 3) +
labs(
title = "Distributions of Key Variables (2021)",
x = NULL, y = "Count"
) + theme_min
p4
```

## Summary 5: Top & Bottom 10 States

```{r plot_lollipop, echo=FALSE}
ranked <- dat |>
  arrange(desc(le)) |>
  mutate(rank = row_number())

top10    <- ranked |> slice_head(n = 10) |> mutate(group = "Top 10")
bottom10 <- ranked |> slice_tail(n = 10) |> arrange(le) |> mutate(group = "Bottom 10")

combined <- bind_rows(top10, bottom10)

levs <- combined |>
  arrange(le) |>
  pull(state)

lob <- combined |>
  mutate(state = factor(state, levels = levs))

x_pad <- 0.5
x_min <- min(lob$le, na.rm = TRUE) - x_pad
x_max <- max(lob$le, na.rm = TRUE) + x_pad

p5 <- ggplot(lob, aes(x = le, y = state, color = group)) +
  geom_segment(aes(x = x_min, xend = le, y = state, yend = state), linewidth = 0.5) +
  geom_point(size = 2) +
  geom_text(aes(label = sprintf("%.1f", le)), hjust = -0.2, size = 3, color = "black") +
  scale_x_continuous(limits = c(x_min, x_max)) +
  labs(
    title = "Life Expectancy: Top and Bottom 10 States (2021)",
    x = "Life expectancy (years)", y = NULL, color = NULL
  ) +
  theme_min +
  theme(legend.position = "top")
p5
```

## Summary 6: Mean LE by PCE Quintile

```{r plot_pce_quintile, echo=FALSE}
if ("pce_quintile" %in% names(dat)) {
p6 <- dat |>
filter(!is.na(pce_quintile)) |>
group_by(pce_quintile) |>
summarise(
n = n(),
mean_le = mean(le, na.rm = TRUE),
se_le = sd(le, na.rm = TRUE) / sqrt(n),
.groups = "drop"
) |>
ggplot(aes(x = pce_quintile, y = mean_le, group = 1)) +
geom_line() +
geom_point(size = 2) +
geom_errorbar(aes(ymin = mean_le - se_le, ymax = mean_le + se_le), width = 0.1) +
labs(
title = "Life Expectancy Increases Across PCE Quintiles",
subtitle = "Points: mean LE; bars: ±1 SE",
x = "PCE quintile (Q1 = lowest … Q5 = highest)", y = "Mean life expectancy (years)"
) + theme_min
p6
}
```

## Summary 7: Rank–Rank: Income Rank vs LE

```{r plot_rank_rank, echo=FALSE}
p7 <- dat |>
ggplot(aes(x = income_rank, y = le)) +
geom_point(alpha = 0.85) +
geom_smooth(method = "lm", se = TRUE) +
scale_x_reverse() +
labs(
title = "Rank–Rank Association: Richer States Live Longer",
x = "Income rank (1 = highest income … 51 = lowest)",
y = "Life expectancy (years)"
) + theme_min
p7
```

## Summary 8: Correlation Heatmap

```{r plot_corr_heatmap, echo=FALSE}
numdat <- dat |>
select(where(is.numeric)) |>
rename(
LE          = le,
Income      = median_household_income,
PCE         = pce,
MedicareEnr = medical_enrollment,
IncomeRank  = income_rank,
PCERank     = pce_rank
)

cor_mat <- round(cor(numdat, use = "pairwise.complete.obs"), 2)
cor_df  <- as.data.frame(as.table(cor_mat))
names(cor_df) <- c("var1", "var2", "corr")

p8 <- ggplot(cor_df, aes(var1, var2, fill = corr)) +
geom_tile() +
geom_text(aes(label = sprintf("%.2f", corr)), size = 3) +
scale_fill_gradient2(limits = c(-1, 1), oob = scales::squish) +
labs(
title = "Correlation Matrix of Key Variables (2021)",
x = NULL, y = NULL, fill = "r"
) +
theme_min +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
p8
```
